{"ast":null,"code":"var _jsxFileName = \"/usr/src/app/utils/auth.tsx\";\nvar __jsx = React.createElement;\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }\nfunction _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\nfunction _toPropertyKey(arg) { var key = _toPrimitive(arg, \"string\"); return typeof key === \"symbol\" ? key : String(key); }\nfunction _toPrimitive(input, hint) { if (typeof input !== \"object\" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || \"default\"); if (typeof res !== \"object\") return res; throw new TypeError(\"@@toPrimitive must return a primitive value.\"); } return (hint === \"string\" ? String : Number)(input); }\nimport React from 'react';\nimport nextCookie from 'next-cookies';\nimport cookie from 'js-cookie';\nimport Router from 'next/router';\nimport { getDisplayName } from 'utils';\nexport function login(token) {\n  cookie.set('token', token, {\n    expires: 1\n  });\n  Router.push('/profile');\n}\nexport function logout() {\n  cookie.remove('token');\n  // to support logging out from all windows\n  window.localStorage.setItem('logout', Date.now().toString());\n  Router.push('/login');\n}\nexport function auth(ctx) {\n  const {\n    token\n  } = nextCookie(ctx);\n  if (ctx.req && !token) {\n    ctx.res.writeHead(302, {\n      Location: '/login'\n    });\n    ctx.res.end();\n  }\n  if (!token) {\n    Router.push('/login');\n  }\n  return token;\n}\nexport const withAuthSync = Component => {\n  var _class;\n  return _class = class WithAuthSync extends React.Component {\n    constructor(...args) {\n      super(...args);\n      _defineProperty(this, \"syncLogout\", event => {\n        if (event.key === 'logout') {\n          Router.push('/login');\n        }\n      });\n    }\n    static async getInitialProps(ctx) {\n      const token = auth(ctx);\n      const componentProps = Component.getInitialProps && (await Component.getInitialProps(ctx));\n      return _objectSpread(_objectSpread({}, componentProps), {}, {\n        token\n      });\n    }\n    componentDidMount() {\n      window.addEventListener('storage', this.syncLogout);\n    }\n    componentWillUnmount() {\n      window.removeEventListener('storage', this.syncLogout);\n      window.localStorage.removeItem('logout');\n    }\n    render() {\n      return __jsx(Component, _extends({}, this.props, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 66,\n          columnNumber: 14\n        }\n      }));\n    }\n  }, _defineProperty(_class, \"displayName\", `withAuthSync(${getDisplayName(Component)})`), _class;\n};","map":{"version":3,"names":["React","nextCookie","cookie","Router","getDisplayName","login","token","set","expires","push","logout","remove","window","localStorage","setItem","Date","now","toString","auth","ctx","req","res","writeHead","Location","end","withAuthSync","Component","_class","WithAuthSync","constructor","args","_defineProperty","event","key","getInitialProps","componentProps","_objectSpread","componentDidMount","addEventListener","syncLogout","componentWillUnmount","removeEventListener","removeItem","render","__jsx","_extends","props","__self","__source","fileName","_jsxFileName","lineNumber","columnNumber"],"sources":["/usr/src/app/utils/auth.tsx"],"sourcesContent":["import React from 'react';\nimport {NextPageContext, NextComponentType} from 'next';\nimport nextCookie from 'next-cookies';\nimport cookie from 'js-cookie';\nimport Router from 'next/router';\nimport {getDisplayName} from 'utils';\n\nexport function login(token: string) {\n  cookie.set('token', token, {expires: 1});\n  Router.push('/profile');\n}\n\nexport function logout() {\n  cookie.remove('token');\n  // to support logging out from all windows\n  window.localStorage.setItem('logout', Date.now().toString());\n  Router.push('/login');\n}\n\nexport function auth(ctx: NextPageContext) {\n  const {token} = nextCookie(ctx);\n\n  if (ctx.req && !token) {\n    ctx.res.writeHead(302, {Location: '/login'});\n    ctx.res.end();\n  }\n\n  if (!token) {\n    Router.push('/login');\n  }\n\n  return token;\n}\n\nexport const withAuthSync = <P extends object>(\n  Component: NextComponentType<P>,\n) => {\n  return class WithAuthSync extends React.Component<P> {\n    static displayName = `withAuthSync(${getDisplayName(Component)})`;\n\n    static async getInitialProps(ctx) {\n      const token = auth(ctx);\n\n      const componentProps =\n        Component.getInitialProps && (await Component.getInitialProps(ctx));\n\n      return {...componentProps, token};\n    }\n\n    componentDidMount() {\n      window.addEventListener('storage', this.syncLogout);\n    }\n\n    componentWillUnmount() {\n      window.removeEventListener('storage', this.syncLogout);\n      window.localStorage.removeItem('logout');\n    }\n\n    syncLogout = event => {\n      if (event.key === 'logout') {\n        Router.push('/login');\n      }\n    };\n\n    render() {\n      return <Component {...(this.props as P)} />;\n    }\n  };\n};\n"],"mappings":";;;;;;;;AAAA,OAAOA,KAAK,MAAM,OAAO;AAEzB,OAAOC,UAAU,MAAM,cAAc;AACrC,OAAOC,MAAM,MAAM,WAAW;AAC9B,OAAOC,MAAM,MAAM,aAAa;AAChC,SAAQC,cAAc,QAAO,OAAO;AAEpC,OAAO,SAASC,KAAKA,CAACC,KAAa,EAAE;EACnCJ,MAAM,CAACK,GAAG,CAAC,OAAO,EAAED,KAAK,EAAE;IAACE,OAAO,EAAE;EAAC,CAAC,CAAC;EACxCL,MAAM,CAACM,IAAI,CAAC,UAAU,CAAC;AACzB;AAEA,OAAO,SAASC,MAAMA,CAAA,EAAG;EACvBR,MAAM,CAACS,MAAM,CAAC,OAAO,CAAC;EACtB;EACAC,MAAM,CAACC,YAAY,CAACC,OAAO,CAAC,QAAQ,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC,CAACC,QAAQ,CAAC,CAAC,CAAC;EAC5Dd,MAAM,CAACM,IAAI,CAAC,QAAQ,CAAC;AACvB;AAEA,OAAO,SAASS,IAAIA,CAACC,GAAoB,EAAE;EACzC,MAAM;IAACb;EAAK,CAAC,GAAGL,UAAU,CAACkB,GAAG,CAAC;EAE/B,IAAIA,GAAG,CAACC,GAAG,IAAI,CAACd,KAAK,EAAE;IACrBa,GAAG,CAACE,GAAG,CAACC,SAAS,CAAC,GAAG,EAAE;MAACC,QAAQ,EAAE;IAAQ,CAAC,CAAC;IAC5CJ,GAAG,CAACE,GAAG,CAACG,GAAG,CAAC,CAAC;EACf;EAEA,IAAI,CAAClB,KAAK,EAAE;IACVH,MAAM,CAACM,IAAI,CAAC,QAAQ,CAAC;EACvB;EAEA,OAAOH,KAAK;AACd;AAEA,OAAO,MAAMmB,YAAY,GACvBC,SAA+B,IAC5B;EAAA,IAAAC,MAAA;EACH,OAAAA,MAAA,GAAO,MAAMC,YAAY,SAAS5B,KAAK,CAAC0B,SAAS,CAAI;IAAAG,YAAA,GAAAC,IAAA;MAAA,SAAAA,IAAA;MAAAC,eAAA,qBAqBtCC,KAAK,IAAI;QACpB,IAAIA,KAAK,CAACC,GAAG,KAAK,QAAQ,EAAE;UAC1B9B,MAAM,CAACM,IAAI,CAAC,QAAQ,CAAC;QACvB;MACF,CAAC;IAAA;IAtBD,aAAayB,eAAeA,CAACf,GAAG,EAAE;MAChC,MAAMb,KAAK,GAAGY,IAAI,CAACC,GAAG,CAAC;MAEvB,MAAMgB,cAAc,GAClBT,SAAS,CAACQ,eAAe,KAAK,MAAMR,SAAS,CAACQ,eAAe,CAACf,GAAG,CAAC,CAAC;MAErE,OAAAiB,aAAA,CAAAA,aAAA,KAAWD,cAAc;QAAE7B;MAAK;IAClC;IAEA+B,iBAAiBA,CAAA,EAAG;MAClBzB,MAAM,CAAC0B,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAACC,UAAU,CAAC;IACrD;IAEAC,oBAAoBA,CAAA,EAAG;MACrB5B,MAAM,CAAC6B,mBAAmB,CAAC,SAAS,EAAE,IAAI,CAACF,UAAU,CAAC;MACtD3B,MAAM,CAACC,YAAY,CAAC6B,UAAU,CAAC,QAAQ,CAAC;IAC1C;IAQAC,MAAMA,CAAA,EAAG;MACP,OAAOC,KAAA,CAAClB,SAAS,EAAAmB,QAAA,KAAM,IAAI,CAACC,KAAK;QAAAC,MAAA;QAAAC,QAAA;UAAAC,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA;MAAA,EAAS,CAAC;IAC7C;EACF,CAAC,EAAArB,eAAA,CAAAJ,MAAA,iBA7BuB,gBAAevB,cAAc,CAACsB,SAAS,CAAE,GAAE,GAAAC,MAAA;AA8BrE,CAAC"},"metadata":{},"sourceType":"module"}